<script>
	import { onMount } from 'svelte';
	import { createEventDispatcher } from 'svelte';
	import Banner from '$lib/Banner.svelte';
	import { Tooltip } from '@skeletonlabs/skeleton-svelte';
	import { Info } from '@lucide/svelte';

	// Expects "players" passed in with extra fields:
	// - is_npc: boolean
	// - assigned_character: { name, image? }
	// - correctGuesses: number
	// - guesses: an array of { guesser_id, guessed_character_name, is_correct }
	export let players = [];
	export let currentUserId;

	const dispatch = createEventDispatcher();

	// Only keep human players for podium + final
	$: humanPlayers = players.filter((p) => !p.is_npc);
	$: sortedHumanPlayers = [...humanPlayers].sort((a, b) => b.points - a.points);

	let revealedPlayers = [];
	let revealedPodium = [];

	let phase = 'identity'; // phases: 'identity', 'podium', 'final'
	const identityDelay = 3000;
	const podiumDelay = 3000;
	const podiumItemDelay = 3000;
	let podiumPlayers = [];

	// Gradually reveal **all** player identities (including NPCs)
	function revealIdentities() {
		players.forEach((player, index) => {
			setTimeout(
				() => {
					revealedPlayers = [...revealedPlayers, player];
					if (index === players.length - 1) {
						setTimeout(() => {
							startPodiumReveal();
						}, podiumDelay);
					}
				},
				identityDelay * (index + 1)
			);
		});
	}

	// Start the podium reveal (up to top 3 human players), always revealing lowest rank first
	function startPodiumReveal() {
		// sort descending and take top 3
		podiumPlayers = [...humanPlayers].sort((a, b) => b.points - a.points).slice(0, 3);

		// reverse so we reveal 3rdâ†’1st (or 2ndâ†’1st if only 2 players, or just 1st)
		const order = [...podiumPlayers].reverse();

		// switch phase immediately so your {#if phase==='podium'} block shows up
		phase = 'podium';

		order.forEach((player, index) => {
			setTimeout(
				() => {
					revealedPodium = [...revealedPodium, player];

					// once the last one is in, wait podiumItemDelay then go to final
					if (index === order.length - 1) {
						setTimeout(() => {
							phase = 'final';
						}, podiumItemDelay);
					}
				},
				podiumItemDelay * (index + 1)
			);
		});
	}

	// Helper to return the current user's guess from a list of guesses.
	function getMyGuess(guesses) {
		return guesses?.find((g) => g.guesser_id === currentUserId) ?? null;
	}

	onMount(() => {
		revealIdentities();
	});

	function handleLeaveLobby() {
		dispatch('leaveLobby');
	}
</script>

<Banner>
	{#if phase === 'identity'}
		<h1 class="h3">TapatybiÅ³ atskleidimas</h1>
	{:else if phase === 'podium'}
		<h1 class="h3">Podiumas</h1>
	{:else}
		<h1 class="h3">Rezultatai</h1>
	{/if}
</Banner>

<main class="flex h-full w-full flex-col items-center justify-center gap-4 overflow-y-auto p-4">
	{#if phase === 'identity'}
		<div class="grid w-full max-w-xl gap-4">
			{#each revealedPlayers as player (player.id)}
				<div class="rounded-lg border p-4 shadow">
					<div class="flex items-center justify-between">
						<div class="flex flex-col">
							<h4 class="text-xl font-bold">
								{player.username}{player.is_host ? ' ğŸ‘‘' : ''}
							</h4>
							{#if player.assigned_character}
								<p class="text-md">
									PersonaÅ¾as: {player.assigned_character.name}
								</p>
							{:else}
								<p class="text-md italic">NÄ—ra pasirinkto personaÅ¾o</p>
							{/if}
						</div>
						{#if player.assigned_character?.image}
							<img
								src={player.assigned_character.image}
								alt={player.assigned_character.name}
								class="h-16 w-16 rounded-full object-cover"
							/>
						{/if}
					</div>
					<p class="text-md mt-2">
						{player.correctGuesses} iÅ¡ {humanPlayers.length - 1} Å¾aidÄ—jÅ³ atspÄ—jo!
					</p>
					{#if player.guesses}
						{#if getMyGuess(player.guesses)}
							<p class="text-md mt-1">
								Tavo spÄ—jimas:
								<span
									class={getMyGuess(player.guesses).is_correct ? 'text-green-500' : 'text-red-500'}
								>
									{getMyGuess(player.guesses).guessed_character_name}
								</span>
							</p>
						{:else}
							<p class="text-md mt-1">
								Tavo spÄ—jimas:
								<span class="text-red-500"> Neatlikai spÄ—jimo Å¡iam Å¾aidÄ—jui </span>
							</p>
						{/if}
					{/if}
				</div>
			{/each}
		</div>
	{:else if phase === 'podium'}
		<div class="flex flex-col items-center gap-4">
			{#each revealedPodium as player, i (player.id)}
				<div class="flex w-full max-w-md items-center gap-4 rounded-lg border p-4 shadow">
					<div class="text-2xl font-bold">
						{podiumPlayers.length === 3
							? i === 0
								? '3. vieta'
								: i === 1
									? '2. vieta'
									: '1. vieta'
							: `${i + 1}. vieta`}
					</div>
					<div class="flex flex-col">
						<h4 class="text-xl font-bold">{player.username}</h4>
						<p class="text-md">TaÅ¡kai: {player.points}</p>
					</div>
				</div>
			{/each}
		</div>
	{:else if phase === 'final'}
		<div class="bg-surface-100-900 grid w-full max-w-xl gap-2 rounded-2xl p-4">
			{#each sortedHumanPlayers as player, i (player.id)}
				<div class="bg-surface-200-800 flex gap-2 rounded-2xl p-4 shadow">
					<header class="flex w-14 flex-col justify-center gap-2 text-center">
						<p title="Vieta" class="text-5xl font-bold">{i + 1}</p>
						{#if player.score_breakdown?.length}
							<Tooltip
								positioning={{
									placement: 'top',
									offset: { mainAxis: 8 },
									flip: true,
									shift: true
								}}
								triggerBase="chip preset-filled-surface-300-700"
								contentBase="card preset-filled-surface-200-800 border border-surface-400-600 shadow-lg p-4 text-start"
								openDelay={100}
							>
								{#snippet trigger()}
									<p>{player.points}</p>
								{/snippet}
								{#snippet content()}
									<h2 class="font-bold">TaÅ¡kÅ³ suvestinÄ— Å¾aidÄ—jui {player.username}</h2>
									<ul class="text-sm">
										{#each player.score_breakdown as line}
											<li><span class="font-semibold">+{line.points}</span> {line.description}</li>
										{/each}
									</ul>
								{/snippet}
							</Tooltip>
						{/if}
					</header>
					<span class="vr border-surface-300-700 border-l-2"></span>
					<div class="flex flex-1 flex-col justify-between">
						<div class="flex flex-col">
							<h4 class="text-xl font-bold">
								{player.username}
							</h4>
							{#if player.assigned_character}
								<p class="text-surface-700-300 italic">
									{player.assigned_character.name}
								</p>
							{:else}
								<p class="text-md italic">NÄ—ra pasirinkto personaÅ¾o</p>
							{/if}
						</div>
						<div class="flex flex-1 flex-col justify-end">
							<p class="text-sm">
								Buvo atspÄ—tas: <span class="font-semibold"
									>{player.correctGuesses ?? 0}/{humanPlayers.length - 1}</span
								>
							</p>

							{#if player.id !== currentUserId && player.guesses}
								{#if getMyGuess(player.guesses)}
									<p class="text-sm">
										Tu spÄ—jai:
										<span
											class="{getMyGuess(player.guesses).is_correct
												? 'text-success-500'
												: 'text-error-500'} font-semibold"
										>
											{getMyGuess(player.guesses).guessed_character_name}
										</span>
									</p>
								{:else}
									<p class="text-sm">
										Tu spÄ—jai:
										<span class="text-error-500 font-semibold"> - </span>
									</p>
								{/if}
							{/if}
						</div>
					</div>
					<footer class="flex flex-col justify-center">
						{#if player.assigned_character?.image}
							<img
								src={player.assigned_character.image}
								alt={player.assigned_character.name}
								class="h-16 w-16 rounded-full object-cover shadow"
							/>
						{/if}
					</footer>
				</div>
			{/each}
		</div>
		<button class="btn preset-filled-primary-500" on:click={handleLeaveLobby}>
			Noriu Å¾aisti vÄ—l!
		</button>
	{/if}
</main>
